#include <Wire.h>
#include <AccelStepper.h>
#include <LiquidCrystal_I2C.h>

// ================= LCD =================
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= MOTORES =================
// 28BYJ-48 + ULN2003 (HALF STEP)
AccelStepper stepperRA (AccelStepper::HALF4WIRE, 8, 10, 9, 11);
AccelStepper stepperDEC(AccelStepper::HALF4WIRE, 4, 6, 5, 7);

// ================= MECÁNICA =================
const float pasosMotor = 4096.0;

const float relacionRA  = 69.0 / 16.0;
const float relacionDEC = 63.0 / 16.0;

const float pasosRevRA  = pasosMotor * relacionRA;
const float pasosRevDEC = pasosMotor * relacionDEC;

const float factorRA  = 1.0;
const float factorDEC = 0.857142857;

// ================= PI =================
float Kp = 0.060;
float Ki = 0.00002;

float integralRA  = 0;
float integralDEC = 0;

// ================= LX200 =================
String inputString = "";

String currentRA  = "00:00:00";
String currentDEC = "+00*00:00";

String targetRA  = "00:00:00";
String targetDEC = "+00*00:00";

// ================= VARIABLES =================
float raDecimal  = 0.0;
float decDecimal = 0.0;

long targetRAsteps  = 0;
long targetDECsteps = 0;

bool moveCommand = false;

// ========== CONVERSIONES ==========
float RAtoDecimal(String ra) {
  int hh = ra.substring(0, 2).toInt();
  int mm = ra.substring(3, 5).toInt();
  int ss = ra.substring(6, 8).toInt();
  return (hh + mm / 60.0 + ss / 3600.0) * 15.0; // horas → grados
}

float DECtoDecimal(String dec) {
  int sign = (dec.charAt(0) == '-') ? -1 : 1;
  int dd = dec.substring(1, 3).toInt();
  int mm = dec.substring(4, 6).toInt();
  int ss = dec.substring(7, 9).toInt();
  return sign * (dd + mm / 60.0 + ss / 3600.0);
}

// ================= SETUP =================
void setup() {
  Serial.begin(9600);

  lcd.init();
  lcd.backlight();
  lcd.print("LX200 Ready");

  stepperRA.setMaxSpeed(900);
  stepperRA.setAcceleration(900);

  stepperDEC.setMaxSpeed(900);
  stepperDEC.setAcceleration(900);
}

// ================= LOOP =================
void loop() {

  // ======= RECEPCIÓN SERIAL =======
  if (Serial.available()) {
    char c = Serial.read();
    inputString += c;

    if (c == '#') {
      processCommand(inputString);
      inputString = "";
    }
  }

  // ======= CONTROL PI =======
  if (moveCommand) {

    // ----- RA -----
    long errorRA = targetRAsteps - stepperRA.currentPosition();
    integralRA += errorRA;
    integralRA = constrain(integralRA, -800, 800);

    float speedRA = Kp * abs(errorRA) + Ki * abs(integralRA);
    speedRA = constrain(speedRA, 100, 900);
    stepperRA.setMaxSpeed(speedRA);

    // ----- DEC -----
    long errorDEC = targetDECsteps - stepperDEC.currentPosition();
    integralDEC += errorDEC;
    integralDEC = constrain(integralDEC, -800, 800);

    float speedDEC = Kp * abs(errorDEC) + Ki * abs(integralDEC);
    speedDEC = constrain(speedDEC, 100, 900);
    stepperDEC.setMaxSpeed(speedDEC);

    stepperRA.run();
    stepperDEC.run();

    if (!stepperRA.isRunning() && !stepperDEC.isRunning()) {
      moveCommand = false;
      integralRA = 0;
      integralDEC = 0;

      currentRA  = targetRA;
      currentDEC = targetDEC;
    }
  }
}

// ================= LX200 =================
void processCommand(String cmd) {

  if (cmd == ":GR#") {
    Serial.print(currentRA); Serial.print("#");
  }

  else if (cmd == ":GD#") {
    Serial.print(currentDEC); Serial.print("#");
  }

  else if (cmd.startsWith(":Sr")) {
    targetRA = cmd.substring(3, cmd.length() - 1);
    Serial.print("1#");
  }

  else if (cmd.startsWith(":Sd")) {
    targetDEC = cmd.substring(3, cmd.length() - 1);
    Serial.print("1#");
  }

  // ======= GOTO REAL =======
  else if (cmd == ":MS#") {

    raDecimal  = RAtoDecimal(targetRA);
    decDecimal = DECtoDecimal(targetDEC);

    targetRAsteps  = (raDecimal  / 360.0) * pasosRevRA  * factorRA;
    targetDECsteps = (decDecimal / 360.0) * pasosRevDEC * factorDEC;

    stepperRA.moveTo(targetRAsteps);
    stepperDEC.moveTo(targetDECsteps);

    moveCommand = true;

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("RA:");
    lcd.print(raDecimal, 10);

    lcd.setCursor(0, 1);
    lcd.print("DEC:");
    lcd.print(decDecimal, 10);

    Serial.print("0#");
  }
}
